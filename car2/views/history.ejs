<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h2>
        <div id="historyList" class="list-group"></div>
    </div>

    <script>
        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007063611-2LjAaylQ" }); // üîπ ‡πÉ‡∏ä‡πâ LIFF ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;
                    console.log("üì¢ userId:", userId);
                    loadHistory(userId);
                }
            } catch (error) {
                console.error("üî• LIFF Error:", error);
            }
        }

        function loadHistory(userId) {
            $.get(`/checklist-history/${userId}`, function (data) {
                if (!data.length) {
                    $("#historyList").html('<div class="alert alert-info">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô</div>');
                    return;
                }

                let html = "";
                data.forEach(entry => {
                    let equipment = [];
                    try {
                        equipment = typeof entry.equipment === "string"
                            ? JSON.parse(entry.equipment)
                            : Array.isArray(entry.equipment)
                                ? entry.equipment
                                : [];

                    } catch (e) {
                        console.error("‚ùå JSON parse failed:", e, entry.equipment);
                    }

                    html += `
                        <div class="list-group-item">
                            <h5>üöó ‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${entry.plate_number}</h5>
                            <p>üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à: ${entry.inspector}</p>
                            <p>üïí ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(entry.submitted_at).toLocaleString("th-TH")}</p>
                            <ul>
                                ${equipment.map(e => `<li>${e.name} - ${e.quantity || 0}  ${e.remark || '-'}</li>`).join("")}
                            </ul>
                        </div>
                    `;
                });

                $("#historyList").html(html);
            }).fail(() => {
                $("#historyList").html('<div class="alert alert-danger">‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>');
            });
        }

        initializeLiff();
    </script>
</body>

</html>